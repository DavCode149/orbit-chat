<script type="module">
/* -------------------------------------------------------------------------- */
/*                          SUPABASE INITIALIZATION                           */
/* -------------------------------------------------------------------------- */

const SUPABASE_URL = "https://YOURPROJECTID.supabase.co";
const SUPABASE_PUBLIC_KEY = "YOUR_PUBLISHABLE_KEY";

const supabaseClient = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_PUBLIC_KEY
);

/* -------------------------------------------------------------------------- */
/*                               USER SESSION                                  */
/* -------------------------------------------------------------------------- */

let currentUser = null;

async function ensureSignedIn() {
  const { data } = await supabaseClient.auth.getSession();
  if (!data.session) {
    window.location.href = "login.html";
    return;
  }

  const userResp = await supabaseClient.auth.getUser();
  currentUser = userResp.data.user;
}

await ensureSignedIn();

/* -------------------------------------------------------------------------- */
/*                                MESSAGE AREA                                 */
/* -------------------------------------------------------------------------- */

const messagesDiv = document.getElementById("messages");

let messagesLoaded = 0;
const MESSAGES_PER_LOAD = 30;
let loadingMore = false;
let reachedEnd = false;

/* Append and prepend functions */
function appendMessage(user, text, self, time) {
  const wrap = document.createElement("div");
  wrap.className = "msg" + (self ? " self" : "");

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent =
    user + (time ? " • " + new Date(time).toLocaleTimeString() : "");

  const txt = document.createElement("div");
  txt.className = "text";
  txt.textContent = text;

  wrap.appendChild(meta);
  wrap.appendChild(txt);
  messagesDiv.appendChild(wrap);
}

function insertMessageAtTop(user, text, self, time) {
  const wrap = document.createElement("div");
  wrap.className = "msg" + (self ? " self" : "");

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent =
    user + (time ? " • " + new Date(time).toLocaleTimeString() : "");

  const txt = document.createElement("div");
  txt.className = "text";
  txt.textContent = text;

  wrap.appendChild(meta);
  wrap.appendChild(txt);
  messagesDiv.prepend(wrap);
}

/* -------------------------------------------------------------------------- */
/*                           LOAD MESSAGE HISTORY                              */
/* -------------------------------------------------------------------------- */

async function loadHistory(initial = false) {
  if (loadingMore || reachedEnd) return;
  loadingMore = true;

  let prevHeight = messagesDiv.scrollHeight;

  const { data, error } = await supabaseClient
    .from("messages")
    .select("id, user_id, content, created_at")
    .order("created_at", { ascending: false })
    .range(messagesLoaded, messagesLoaded + MESSAGES_PER_LOAD - 1);

  if (error) {
    console.error(error);
    loadingMore = false;
    return;
  }

  if (data.length === 0) {
    reachedEnd = true;
    loadingMore = false;
    return;
  }

  data.reverse();

  if (initial) messagesDiv.innerHTML = "";

  data.forEach(m => {
    const self = currentUser && m.user_id === currentUser.email;
    insertMessageAtTop(m.user_id, m.content, self, m.created_at);
  });

  messagesLoaded += data.length;

  if (!initial) {
    messagesDiv.scrollTop = messagesDiv.scrollHeight - prevHeight;
  } else {
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  loadingMore = false;
}

/* Load first messages */
await loadHistory(true);

/* Infinite scroll */
messagesDiv.addEventListener("scroll", () => {
  if (messagesDiv.scrollTop === 0) loadHistory(false);
});

/* -------------------------------------------------------------------------- */
/*                                SEND MESSAGE                                 */
/* -------------------------------------------------------------------------- */

async function sendMessage() {
  const text = document.getElementById("messageInput").value.trim();
  if (!text) return;

  await supabaseClient.from("messages").insert([
    { user_id: currentUser.email, content: text }
  ]);

  document.getElementById("messageInput").value = "";
}
window.sendMessage = sendMessage;

/* -------------------------------------------------------------------------- */
/*                                   LOGOUT                                    */
/* -------------------------------------------------------------------------- */

async function logout() {
  await supabaseClient.auth.signOut();
  window.location.href = "login.html";
}
window.logout = logout;

/* -------------------------------------------------------------------------- */
/*                              REALTIME (ABLY)                                */
/* -------------------------------------------------------------------------- */

import Ably from "https://cdn.ably.io/lib/ably.min-1.js";

const ably = new Ably.Realtime.Promise({ key: "YOUR_ABLY_KEY" });
const channel = ably.channels.get("main");

channel.subscribe("new-message", (msg) => {
  const m = msg.data;
  const self = m.user_id === currentUser.email;
  appendMessage(m.user_id, m.content, self, m.created_at);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});
</script>
