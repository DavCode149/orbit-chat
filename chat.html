<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Chat</title>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- ABLY (NO MODULE MODE — FIXES YOUR ERROR) -->
<script src="https://cdn.ably.io/lib/ably.min-1.js"></script>

<style>
  body {
    margin: 0;
    height: 100vh;
    background: linear-gradient(135deg, #4a00e0, #8e2de2);
    font-family: 'Inter', sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .container {
    width: 90%;
    max-width: 900px;
    height: 90vh;
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(14px);
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 0 40px rgba(0,0,0,0.25);
  }

  .header {
    padding: 20px;
    color: white;
    font-size: 22px;
    font-weight: 700;
    border-bottom: 2px solid rgba(255,255,255,0.2);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  #sidebarBtn {
    background: rgba(255,255,255,0.4);
    padding: 8px 14px;
    border-radius: 10px;
    cursor: pointer;
    color: white;
    border: none;
    font-weight: 600;
  }

  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
  }

  .msg {
    margin-bottom: 15px;
    padding: 12px 16px;
    background: rgba(255,255,255,0.25);
    border-radius: 12px;
    width: fit-content;
    max-width: 70%;
    animation: fade 0.25s ease;
  }

  .msg.self {
    margin-left: auto;
    background: rgba(255,255,255,0.45);
  }

  @keyframes fade {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .meta {
    font-size: 12px;
    color: #f1e8ff;
    margin-bottom: 3px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .meta img {
    width: 22px;
    height: 22px;
    border-radius: 50%;
  }

  .text {
    font-size: 15px;
    color: white;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .inputRow {
    padding: 15px;
    display: flex;
    gap: 10px;
    border-top: 2px solid rgba(255,255,255,0.2);
  }

  #messageInput {
    flex: 1;
    padding: 12px;
    border-radius: 10px;
    border: none;
    font-size: 16px;
  }

  button {
    padding: 12px 20px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-weight: 600;
  }

  #logout {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(255,255,255,0.4);
  }

  /* SIDEBAR POPUP */
  #profilePopup {
    position: fixed;
    top: 50%;
    left: 50%;
    width: 300px;
    padding: 20px;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 15px;
    display: none;
    flex-direction: column;
    gap: 10px;
  }

  #profilePopup input {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
  }

  #profilePopup button {
    background: #8e2de2;
    color: white;
  }

</style>
</head>
<body>

<button id="logout" onclick="logout()">Logout</button>

<div class="container">
  <div class="header">
    Chat
    <button id="sidebarBtn" onclick="openProfile()">Profile</button>
  </div>

  <div id="messages"></div>

  <div class="inputRow">
    <input id="messageInput" type="text" placeholder="Type a message..." />
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<!-- PROFILE POPUP -->
<div id="profilePopup">
  <h3>Edit Profile</h3>
  <input id="usernameInput" placeholder="Username" />
  <input id="avatarInput" placeholder="Avatar URL" />
  <button onclick="saveProfile()">Save</button>
  <button onclick="closeProfile()" style="background:#ccc;color:black">Close</button>
</div>

<script>
/* ============================================================
   SUPABASE INIT
============================================================ */
const supabaseClient = supabase.createClient(
  "https://fplidqudsdfoyzbamwxy.supabase.co",
  "sb_publishable_OQInItoU8k9bocyqvvARmQ_nPej9ywI"
);

let currentUser = null;
let currentProfile = null;

/* ============================================================
   AUTH + LOAD PROFILE
============================================================ */
async function ensureSignedIn() {
  const { data } = await supabaseClient.auth.getSession();
  if (!data.session) {
    window.location.href = "login.html";
    return;
  }

  currentUser = data.session.user;

  let { data: profile } = await supabaseClient
    .from("profiles")
    .select("*")
    .eq("id", currentUser.id)
    .single();

  if (!profile) {
    profile = {
      id: currentUser.id,
      username: "user" + Math.floor(Math.random() * 9000 + 1000),
      avatar_url: "https://api.dicebear.com/9.x/bottts/svg?seed=" + currentUser.id
    };

    await supabaseClient.from("profiles").insert(profile);
  }

  currentProfile = profile;
}

await ensureSignedIn();

/* ============================================================
   DOM HELPERS
============================================================ */
const messagesDiv = document.getElementById("messages");

function renderMessage(m, isSelf) {
  const msg = document.createElement("div");
  msg.className = "msg" + (isSelf ? " self" : "");

  const meta = document.createElement("div");
  meta.className = "meta";

  const avatar = document.createElement("img");
  avatar.src = m.avatar_url;

  meta.appendChild(avatar);
  meta.appendChild(document.createTextNode(`${m.username} • ${new Date(m.created_at).toLocaleTimeString()}`));

  const text = document.createElement("div");
  text.className = "text";
  text.textContent = m.content;

  msg.appendChild(meta);
  msg.appendChild(text);

  messagesDiv.appendChild(msg);
}

/* ============================================================
   HISTORY LOADING
============================================================ */
let loaded = 0;

async function loadHistory() {
  const { data } = await supabaseClient
    .from("messages")
    .select("*, profiles(username,avatar_url)")
    .order("created_at", { ascending: true })
    .limit(50)
    .range(loaded, loaded + 49);

  if (!data || data.length === 0) return;

  data.forEach(m => {
    const isSelf = m.user_id === currentUser.id;
    renderMessage(
      {
        username: m.profiles.username,
        avatar_url: m.profiles.avatar_url,
        content: m.content,
        created_at: m.created_at
      },
      isSelf
    );
  });

  loaded += data.length;
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

await loadHistory();

/* ============================================================
   SEND MESSAGE
============================================================ */
async function sendMessage() {
  const input = document.getElementById("messageInput");
  const text = input.value.trim();
  if (!text) return;

  await supabaseClient.from("messages").insert({
    user_id: currentUser.id,
    content: text
  });

  input.value = "";
}
window.sendMessage = sendMessage;

/* ============================================================
   LOGOUT
============================================================ */
async function logout() {
  await supabaseClient.auth.signOut();
  window.location.href = "login.html";
}

/* ============================================================
   REALTIME (ABLY)
============================================================ */
const ably = new Ably.Realtime({ key: "dCBOwQ.bGm1Sg:GFVHW6iRMtARjt2Vsfi4xINJshpQnwxIdeUciGcnY6I" });

const channel = ably.channels.get("main");

channel.subscribe("new-message", async (msg) => {
  const m = msg.data;

  renderMessage(m, m.user_id === currentUser.id);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

/* ============================================================
   PROFILE POPUP
============================================================ */
function openProfile() {
  document.getElementById("profilePopup").style.display = "flex";
  document.getElementById("usernameInput").value = currentProfile.username;
  document.getElementById("avatarInput").value = currentProfile.avatar_url;
}

function closeProfile() {
  document.getElementById("profilePopup").style.display = "none";
}

async function saveProfile() {
  const username = document.getElementById("usernameInput").value.trim();
  const avatar_url = document.getElementById("avatarInput").value.trim();

  await supabaseClient
    .from("profiles")
    .update({ username, avatar_url })
    .eq("id", currentUser.id);

  currentProfile.username = username;
  currentProfile.avatar_url = avatar_url;

  closeProfile();
}

</script>
</body>
</html>
