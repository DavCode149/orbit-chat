<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat</title>
  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      background: #f1f3f6;
      font-family: Arial, sans-serif;
    }

    /* ----- SIDEBAR ----- */
    #sidebar {
      width: 250px;
      background: #222;
      color: white;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    #sidebar h2 {
      margin: 0;
      margin-bottom: 15px;
      font-size: 20px;
    }
    .sidebar-item {
      padding: 10px;
      background: #333;
      border-radius: 5px;
      cursor: pointer;
    }
    .sidebar-item:hover {
      background: #444;
    }

    /* ----- MAIN CHAT AREA ----- */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    #messages {
      flex: 1;
      overflow-y: scroll;
      padding: 20px;
      display: flex;
      flex-direction: column-reverse;
    }

    .message {
      display: flex;
      align-items: flex-start;
      background: #fff;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 8px;
      gap: 10px;
      max-width: 500px;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
    }

    .msg-text {
      display: flex;
      flex-direction: column;
    }

    .msg-username {
      font-weight: bold;
      margin-bottom: 3px;
    }

    #input-area {
      padding: 10px;
      background: #fff;
      display: flex;
      gap: 10px;
    }

    #input-area input {
      flex: 1;
      padding: 10px;
    }

    #input-area button {
      padding: 10px 20px;
    }

    /* ----- POPUP ----- */
    #profile-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 300px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      display: none;
      flex-direction: column;
      gap: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }
    #profile-popup input {
      padding: 8px;
      width: 100%;
    }
    #profile-popup button {
      padding: 10px;
    }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <div id="sidebar">
    <h2>Menu</h2>
    <div class="sidebar-item" onclick="openProfile()">Profile</div>
  </div>

  <!-- MAIN CHAT -->
  <div id="main">
    <div id="messages"></div>

    <div id="input-area">
      <input id="messageInput" type="text" placeholder="Type a messageâ€¦" />
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <!-- PROFILE POPUP -->
  <div id="profile-popup">
    <h3>Edit Profile</h3>
    <input id="usernameInput" placeholder="Username" />
    <input id="avatarInput" placeholder="Avatar URL" />
    <button onclick="saveProfile()">Save</button>
    <button onclick="closeProfile()">Close</button>
  </div>


  <!-- SUPABASE -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const supabase = createClient(
      "YOUR_SUPABASE_URL",
      "YOUR_SUPABASE_ANON_KEY"
    );

    let currentUser = null;
    let loadingMessages = false;
    let earliestMessageId = null;

    //------------------------------------
    // LOGIN / FETCH USER PROFILE
    //------------------------------------
    async function initUser() {
      const { data: { user } } = await supabase.auth.getUser();
      currentUser = user;

      if (!currentUser) {
        alert("Not logged in.");
        return;
      }

      // Get existing profile
      let { data: profile } = await supabase
        .from("profiles")
        .select("*")
        .eq("id", currentUser.id)
        .single();

      if (!profile) {
        // Auto-generate username: "user####"
        const randomUser = "user" + Math.floor(Math.random() * 9000 + 1000);

        await supabase.from("profiles").insert({
          id: currentUser.id,
          username: randomUser,
          avatar_url: "https://api.dicebear.com/7.x/bottts/svg?seed=" + randomUser
        });

        profile = { username: randomUser };
      }

      document.getElementById("usernameInput").value = profile.username;
      document.getElementById("avatarInput").value = profile.avatar_url;
    }

    //------------------------------------
    // SAVE PROFILE
    //------------------------------------
    async function saveProfile() {
      const username = document.getElementById("usernameInput").value;
      const avatar = document.getElementById("avatarInput").value;

      await supabase
        .from("profiles")
        .update({ username, avatar_url: avatar })
        .eq("id", currentUser.id);

      closeProfile();
    }

    window.openProfile = () => {
      document.getElementById("profile-popup").style.display = "flex";
    };
    window.closeProfile = () => {
      document.getElementById("profile-popup").style.display = "none";
    };

    //------------------------------------
    // SEND MESSAGE
    //------------------------------------
    window.sendMessage = async function () {
      const input = document.getElementById("messageInput");
      const text = input.value.trim();
      if (text.length === 0) return;

      const { data: profile } = await supabase
        .from("profiles")
        .select("*")
        .eq("id", currentUser.id)
        .single();

      await supabase.from("messages").insert({
        user_id: currentUser.id,
        username: profile.username,
        avatar_url: profile.avatar_url,
        content: text
      });

      input.value = "";
    };

    //------------------------------------
    // LOAD MESSAGES (LATEST 30)
    //------------------------------------
    async function loadMessages(initial = false) {
      if (loadingMessages) return;
      loadingMessages = true;

      let query = supabase
        .from("messages")
        .select("*")
        .order("id", { ascending: false })
        .limit(30);

      if (!initial && earliestMessageId) {
        query = query.lt("id", earliestMessageId);
      }

      const { data } = await query;

      if (data.length > 0) {
        if (!earliestMessageId) earliestMessageId = data[data.length - 1].id;
        else earliestMessageId = data[data.length - 1].id;

        data.forEach(msg => addMessageToUI(msg, false));
      }

      loadingMessages = false;
    }

    //------------------------------------
    // SCROLL TO LOAD MORE
    //------------------------------------
    document.getElementById("messages").addEventListener("scroll", async function () {
      if (this.scrollTop > -10) {
        await loadMessages(false);
      }
    });

    //------------------------------------
    // RENDER MESSAGE
    //------------------------------------
    function addMessageToUI(msg, realtime = true) {
      const messagesDiv = document.getElementById("messages");
      const el = document.createElement("div");
      el.className = "message";

      el.innerHTML = `
        <div class="avatar" style="background-image:url('${msg.avatar_url || ""}')"></div>
        <div class="msg-text">
          <div class="msg-username">${msg.username || "Unknown"}</div>
          <div>${msg.content}</div>
        </div>
      `;

      if (realtime) {
        messagesDiv.prepend(el);
      } else {
        messagesDiv.append(el);
      }
    }

    //------------------------------------
    // REALTIME SUBSCRIPTION
    //------------------------------------
    supabase
      .channel("chat")
      .on("postgres_changes", { event: "INSERT", schema: "public", table: "messages" }, (payload) => {
        addMessageToUI(payload.new, true);
      })
      .subscribe();

    //------------------------------------
    // INIT
    //------------------------------------
    initUser();
    loadMessages(true);
  </script>

</body>
</html>
