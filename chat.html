<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Chat</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.ably.io/lib/ably.min-1.js"></script>

<style>
  body {
    margin: 0;
    height: 100vh;
    background: linear-gradient(135deg, #4a00e0, #8e2de2);
    font-family: 'Inter', sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .container {
    width: 90%;
    max-width: 900px;
    height: 90vh;
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(14px);
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 0 40px rgba(0,0,0,0.25);
  }

  .header {
    padding: 20px;
    color: white;
    font-size: 22px;
    font-weight: 700;
    border-bottom: 2px solid rgba(255,255,255,0.2);
  }

  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
  }

  .msg {
    margin-bottom: 15px;
    padding: 12px 16px;
    background: rgba(255,255,255,0.25);
    border-radius: 12px;
    width: fit-content;
    max-width: 70%;
    animation: fade 0.25s ease;
  }

  .self {
    margin-left: auto;
    background: rgba(255,255,255,0.45);
  }

  @keyframes fade {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .meta {
    font-size: 12px;
    color: #f1e8ff;
    margin-bottom: 3px;
  }

  .text {
    font-size: 15px;
    color: white;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .inputRow {
    padding: 15px;
    display: flex;
    gap: 10px;
    border-top: 2px solid rgba(255,255,255,0.2);
  }

  #messageInput {
    flex: 1;
    padding: 12px;
    border-radius: 10px;
    border: none;
    font-size: 16px;
  }

  button {
    padding: 12px 20px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-weight: 600;
  }

  #logout {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(255,255,255,0.4);
  }
</style>
</head>

<body>

<button id="logout" onclick="logout()">Logout</button>

<div class="container">
  <div class="header">Chat</div>
  <div id="messages"></div>

  <div class="inputRow">
    <input id="messageInput" type="text" placeholder="Type a message..." />
    <button onclick="sendMessage()">Send</button>
  </div>
</div>
<script type="module">
/* -------------------------------------------------------------------------- */
/*                          SUPABASE INITIALIZATION                           */
/* -------------------------------------------------------------------------- */

const SUPABASE_URL = "fplidqudsdfoyzbamwxy.supabase.co";
const SUPABASE_PUBLIC_KEY = "sb_publishable_OQInItoU8k9bocyqvvARmQ_nPej9ywI";

const supabaseClient = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_PUBLIC_KEY
);

/* -------------------------------------------------------------------------- */
/*                               USER SESSION                                  */
/* -------------------------------------------------------------------------- */

let currentUser = null;

async function ensureSignedIn() {
  const { data } = await supabaseClient.auth.getSession();
  if (!data.session) {
    window.location.href = "login.html";
    return;
  }

  const userResp = await supabaseClient.auth.getUser();
  currentUser = userResp.data.user;
}

await ensureSignedIn();

/* -------------------------------------------------------------------------- */
/*                                MESSAGE AREA                                 */
/* -------------------------------------------------------------------------- */

const messagesDiv = document.getElementById("messages");

let messagesLoaded = 0;
const MESSAGES_PER_LOAD = 30;
let loadingMore = false;
let reachedEnd = false;

/* Append and prepend functions */
function appendMessage(user, text, self, time) {
  const wrap = document.createElement("div");
  wrap.className = "msg" + (self ? " self" : "");

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent =
    user + (time ? " • " + new Date(time).toLocaleTimeString() : "");

  const txt = document.createElement("div");
  txt.className = "text";
  txt.textContent = text;

  wrap.appendChild(meta);
  wrap.appendChild(txt);
  messagesDiv.appendChild(wrap);
}

function insertMessageAtTop(user, text, self, time) {
  const wrap = document.createElement("div");
  wrap.className = "msg" + (self ? " self" : "");

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent =
    user + (time ? " • " + new Date(time).toLocaleTimeString() : "");

  const txt = document.createElement("div");
  txt.className = "text";
  txt.textContent = text;

  wrap.appendChild(meta);
  wrap.appendChild(txt);
  messagesDiv.prepend(wrap);
}

/* -------------------------------------------------------------------------- */
/*                           LOAD MESSAGE HISTORY                              */
/* -------------------------------------------------------------------------- */

async function loadHistory(initial = false) {
  if (loadingMore || reachedEnd) return;
  loadingMore = true;

  let prevHeight = messagesDiv.scrollHeight;

  const { data, error } = await supabaseClient
    .from("messages")
    .select("id, user_id, content, created_at")
    .order("created_at", { ascending: false })
    .range(messagesLoaded, messagesLoaded + MESSAGES_PER_LOAD - 1);

  if (error) {
    console.error(error);
    loadingMore = false;
    return;
  }

  if (data.length === 0) {
    reachedEnd = true;
    loadingMore = false;
    return;
  }

  data.reverse();

  if (initial) messagesDiv.innerHTML = "";

  data.forEach(m => {
    const self = currentUser && m.user_id === currentUser.email;
    insertMessageAtTop(m.user_id, m.content, self, m.created_at);
  });

  messagesLoaded += data.length;

  if (!initial) {
    messagesDiv.scrollTop = messagesDiv.scrollHeight - prevHeight;
  } else {
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  loadingMore = false;
}

/* Load first messages */
await loadHistory(true);

/* Infinite scroll */
messagesDiv.addEventListener("scroll", () => {
  if (messagesDiv.scrollTop === 0) loadHistory(false);
});

/* -------------------------------------------------------------------------- */
/*                                SEND MESSAGE                                 */
/* -------------------------------------------------------------------------- */

async function sendMessage() {
  const text = document.getElementById("messageInput").value.trim();
  if (!text) return;

  await supabaseClient.from("messages").insert([
    { user_id: currentUser.email, content: text }
  ]);

  document.getElementById("messageInput").value = "";
}
window.sendMessage = sendMessage;

/* -------------------------------------------------------------------------- */
/*                                   LOGOUT                                    */
/* -------------------------------------------------------------------------- */

async function logout() {
  await supabaseClient.auth.signOut();
  window.location.href = "login.html";
}
window.logout = logout;

/* -------------------------------------------------------------------------- */
/*                              REALTIME (ABLY)                                */
/* -------------------------------------------------------------------------- */

import Ably from "https://cdn.ably.io/lib/ably.min-1.js";

const ably = new Ably.Realtime.Promise({ key: "dCBOwQ.bGm1Sg:GFVHW6iRMtARjt2Vsfi4xINJshpQnwxIdeUciGcnY6I" });
const channel = ably.channels.get("main");

channel.subscribe("new-message", (msg) => {
  const m = msg.data;
  const self = m.user_id === currentUser.email;
  appendMessage(m.user_id, m.content, self, m.created_at);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});
</script>
</body>
</html>
