<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Social Chat (fixed)</title>

<!-- Supabase v2 (global) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- Ably (global) -->
<script src="https://cdn.ably.io/lib/ably.min-1.js"></script>

<style>
  :root{
    --bg1:#4a00e0;
    --bg2:#8e2de2;
    --glass: rgba(255,255,255,0.12);
    --white-soft: rgba(255,255,255,0.95);
  }
  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{
    background: linear-gradient(135deg,var(--bg1),var(--bg2));
    color:var(--white-soft);
    -webkit-font-smoothing:antialiased;
  }

  /* Layout */
  .app {
    height:100vh;
    display:grid;
    grid-template-columns:260px 1fr;
    gap:18px;
    padding:20px;
    box-sizing:border-box;
  }

  /* Sidebar */
  .sidebar {
    background:var(--glass);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-radius:14px;
    padding:16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    display:flex; flex-direction:column;
    gap:10px;
  }
  .sidebar h3 { margin:0 0 6px 0; font-size:16px; }
  .profile-row { display:flex; gap:12px; align-items:center; }
  .avatar-small { width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.08); }

  .menu-btn {
    padding:8px 10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--white-soft);cursor:pointer;
  }

  .users-list { overflow:auto; margin-top:8px; }

  /* Panel */
  .panel {
    display:flex; flex-direction:column; background:var(--glass);
    padding:14px; border-radius:14px; box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    min-height:0; overflow:hidden;
  }

  .panel .header {
    display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;
  }
  .panel .header .title { font-weight:700; font-size:18px; }
  .you-info { opacity:0.9; font-size:13px; }

  .messages {
    flex:1; overflow:auto; padding:12px; display:flex; flex-direction:column; gap:12px;
  }

  .message {
    display:flex; gap:10px; align-items:flex-start;
    padding:10px; border-radius:12px; background: rgba(255,255,255,0.06); max-width:75%;
  }
  .message.self { margin-left:auto; background: rgba(255,255,255,0.22); color:#111; }
  .message .meta { font-size:13px; font-weight:700; margin-bottom:6px; display:flex; gap:8px; align-items:center; }
  .message .meta img { width:32px; height:32px; border-radius:50%; object-fit:cover; border:2px solid rgba(255,255,255,0.08); }
  .message .text { font-size:14px; white-space:pre-wrap; }

  .input-row { display:flex; gap:10px; margin-top:12px; align-items:center; }
  .message-input { flex:1; padding:12px;border-radius:12px;border:none; outline:none; background: rgba(255,255,255,0.06); color:var(--white-soft); resize:none; }
  .send-btn { padding:10px 14px; border-radius:10px; border:none; font-weight:700; background:linear-gradient(90deg,#fff,#f1e8ff); color:#111; cursor:pointer; }

  /* profile popup */
  .popup-backdrop {
    position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.4); z-index:999;
  }
  .popup {
    width:320px; background:var(--white-soft); color:#111; border-radius:12px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,0.4);
  }
  .popup input { width:100%; padding:8px; margin-bottom:8px; border-radius:8px; border:1px solid #ddd; }

  @media (max-width:900px){
    .app { grid-template-columns:1fr; padding:12px; }
    .sidebar { order:2; height:150px; overflow:auto; }
    .panel { order:1; }
  }
</style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="profile-row">
      <img id="meAvatar" class="avatar-small" src="/mnt/data/33edf7c5-8529-4cc8-8e28-083269e2fd3e.png" alt="avatar">
      <div>
        <div id="meName" style="font-weight:700">Loading...</div>
        <div style="font-size:12px;opacity:0.9" id="meEmail"></div>
      </div>
    </div>

    <button class="menu-btn" id="openProfileBtn">Edit Profile</button>
    <button class="menu-btn" id="logoutBtn">Logout</button>

    <hr style="border:none;border-top:1px solid rgba(255,255,255,0.04)" />

    <div style="font-size:13px; opacity:0.9;">Online</div>
    <div class="users-list" id="usersList"></div>
  </aside>

  <!-- Main -->
  <main class="panel">
    <div class="header">
      <div>
        <div class="title">#general</div>
        <div class="subtitle" style="opacity:0.85; font-size:13px;">Public chat — be kind</div>
      </div>
      <div class="you-info" id="youInfo">You</div>
    </div>

    <div class="messages" id="messages"></div>

    <div id="typing" style="font-size:13px; opacity:0.85; margin-top:6px;"></div>

    <div class="input-row">
      <textarea id="messageInput" class="message-input" rows="1" placeholder="Say something..." ></textarea>
      <button id="sendBtn" class="send-btn">Send</button>
    </div>
  </main>
</div>

<!-- Profile popup -->
<div class="popup-backdrop" id="popupBackdrop">
  <div class="popup">
    <h3>Edit profile</h3>
    <label>Username</label>
    <input id="usernameInput" placeholder="username" />
    <label>Avatar URL (or leave blank for default)</label>
    <input id="avatarInput" placeholder="avatar url" />
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
      <button id="saveProfileBtn">Save</button>
      <button id="closeProfileBtn">Close</button>
    </div>
  </div>
</div>

<script type="module">
/* --------------------- CONFIG - keep your values --------------------- */
const SUPABASE_URL = "https://fplidqudsdfoyzbamwxy.supabase.co";
const SUPABASE_PUBLIC_KEY = "sb_publishable_OQInItoU8k9bocyqvvARmQ_nPej9ywI";
const ABLY_API_KEY = "dCBOwQ.bGm1Sg:GFVHW6iRMtARjt2Vsfi4xINJshpQnwxIdeUciGcnY6I";
/* --------------------------------------------------------------------- */

/* default avatar path (uploaded image) */
const DEFAULT_AVATAR = "/mnt/data/33edf7c5-8529-4cc8-8e28-083269e2fd3e.png";

/* Supabase client (global SDK) */
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_PUBLIC_KEY);

/* DOM refs */
const messagesDiv = document.getElementById("messages");
const usersList = document.getElementById("usersList");
const meAvatar = document.getElementById("meAvatar");
const meName = document.getElementById("meName");
const meEmail = document.getElementById("meEmail");
const youInfo = document.getElementById("youInfo");
const typingDiv = document.getElementById("typing");

const popupBackdrop = document.getElementById("popupBackdrop");
const usernameInput = document.getElementById("usernameInput");
const avatarInput = document.getElementById("avatarInput");
const saveProfileBtn = document.getElementById("saveProfileBtn");
const closeProfileBtn = document.getElementById("closeProfileBtn");
const openProfileBtn = document.getElementById("openProfileBtn");

let currentUser = null;
let currentProfile = null;
let messagesLoaded = 0;
const MESSAGES_PER_LOAD = 30;
let loadingMore = false;
let reachedEnd = false;

/* Ably / presence placeholders - will create after user known */
let ably = null;
let presenceChannel = null;
let pubChannel = null;

/* --------------------- helpers --------------------- */
function renderMessageElement(username, avatar, text, self=false, time=null) {
  const outer = document.createElement("div");
  outer.className = "message" + (self ? " self" : "");

  const avatarWrap = document.createElement("div");
  avatarWrap.style.flex = "0 0 44px";
  const img = document.createElement("img");
  img.src = avatar || DEFAULT_AVATAR;
  img.className = "avatar";
  img.style.width = "44px";
  img.style.height = "44px";
  avatarWrap.appendChild(img);

  const body = document.createElement("div");
  body.style.display = "flex";
  body.style.flexDirection = "column";

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.innerHTML = `<img src="${avatar || DEFAULT_AVATAR}" alt="av"> <span>${username || "Unknown"}</span>` + (time ? ` • ${new Date(time).toLocaleTimeString()}` : "");

  const txt = document.createElement("div");
  txt.className = "text";
  txt.textContent = text;

  body.appendChild(meta);
  body.appendChild(txt);

  outer.appendChild(avatarWrap);
  outer.appendChild(body);

  return outer;
}

function appendMessage(username, avatar, text, self=false, time=null){
  const el = renderMessageElement(username, avatar, text, self, time);
  messagesDiv.appendChild(el);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function insertMessageAtTop(username, avatar, text, self=false, time=null){
  const prev = messagesDiv.scrollHeight;
  const el = renderMessageElement(username, avatar, text, self, time);
  messagesDiv.prepend(el);
  messagesDiv.scrollTop = messagesDiv.scrollHeight - prev;
}

/* --------------------- auth & profile --------------------- */
async function ensureSignedInAndProfile(){
  const { data } = await supabaseClient.auth.getSession();
  if (!data.session) {
    window.location.href = "login.html";
    return false;
  }

  const userResp = await supabaseClient.auth.getUser();
  currentUser = userResp.data.user;

  // show email username short in sidebar
  meEmail.textContent = currentUser.email || "";
  youInfo.textContent = currentUser.email ? currentUser.email.split("@")[0] : "You";

  // fetch profile (profiles: id uuid PK, username text, avatar_url text)
  let { data: profile, error } = await supabaseClient
    .from('profiles')
    .select('id, username, avatar_url')
    .eq('id', currentUser.id)
    .maybeSingle();

  if (error) {
    console.error("profile fetch error", error);
  }

  if (!profile) {
    // create with generated username
    const randomName = "user" + Math.floor(1000 + Math.random() * 9000);
    const avatarUrl = DEFAULT_AVATAR; // or dicebear
    const { error: insErr } = await supabaseClient.from('profiles').insert([
      { id: currentUser.id, username: randomName, avatar_url: avatarUrl }
    ]);
    if (insErr) console.error("insert profile error", insErr);
    profile = { id: currentUser.id, username: randomName, avatar_url: avatarUrl };
  } else {
    // ensure defaults
    if (!profile.avatar_url) {
      profile.avatar_url = DEFAULT_AVATAR;
      await supabaseClient.from('profiles').update({ avatar_url: profile.avatar_url }).eq('id', currentUser.id);
    }
    if (!profile.username) {
      const randomName = "user" + Math.floor(1000 + Math.random() * 9000);
      profile.username = randomName;
      await supabaseClient.from('profiles').update({ username: randomName }).eq('id', currentUser.id);
    }
  }

  currentProfile = profile;
  meName.textContent = currentProfile.username || (currentUser.email ? currentUser.email.split("@")[0] : "You");
  meAvatar.src = currentProfile.avatar_url || DEFAULT_AVATAR;
  usernameInput.value = currentProfile.username || "";
  avatarInput.value = currentProfile.avatar_url || "";

  return true;
}

/* --------------------- presence (Ably) --------------------- */
function initAblyAndPresence() {
  // create Ably with clientId = currentUser.id so presence.enter works
  ably = new Ably.Realtime({ key: ABLY_API_KEY, clientId: currentUser.id });
  presenceChannel = ably.channels.get("social-presence");
  pubChannel = ably.channels.get("social-chat");

  // enter presence with profile data
  presenceChannel.presence.enter(currentProfile.username, { avatar: currentProfile.avatar_url || DEFAULT_AVATAR, username: currentProfile.username });

  // subscribe to presence updates and get current members
  presenceChannel.presence.subscribe(() => updateUsersFromPresence());
  presenceChannel.presence.get((err, members) => updateUsersFromPresence(err, members));
}

function updateUsersFromPresence(err, members){
  let list = [];
  if (Array.isArray(members)) list = members;
  else if (Array.isArray(arguments[0])) list = arguments[0];
  usersList.innerHTML = "";
  (list || []).forEach(m => {
    const row = document.createElement("div");
    row.style.display = "flex"; row.style.alignItems = "center"; row.style.gap = "10px"; row.style.padding = "6px"; row.style.borderRadius = "8px"; row.style.marginBottom = "6px";
    const img = document.createElement("img"); img.src = (m.data && m.data.avatar) ? m.data.avatar : DEFAULT_AVATAR; img.style.width="36px"; img.style.height="36px"; img.style.borderRadius="50%";
    const meta = document.createElement("div"); meta.style.fontSize="13px"; meta.style.fontWeight="600"; meta.textContent = m.clientId || (m.data && m.data.username) || "Anon";
    row.appendChild(img); row.appendChild(meta);
    usersList.appendChild(row);
  });
}

/* --------------------- load history (30 newest, paging up) --------------------- */
async function loadHistory(initial=false){
  if (loadingMore || reachedEnd) return;
  loadingMore = true;
  const prevHeight = messagesDiv.scrollHeight;

  const { data, error } = await supabaseClient
    .from('messages')
    .select('id, user_id, content, created_at, profiles(username, avatar_url)')
    .order('created_at', { ascending: false })
    .range(messagesLoaded, messagesLoaded + MESSAGES_PER_LOAD - 1);

  if (error) {
    console.error("history load error:", error);
    loadingMore = false;
    return;
  }

  if (!data || data.length === 0) {
    reachedEnd = true;
    loadingMore = false;
    return;
  }

  data.reverse(); // oldest -> newest

  if (initial) messagesDiv.innerHTML = "";

  for (const row of data) {
    // profiles is a join; if present it's an array with one item
    const profile = (row.profiles && Array.isArray(row.profiles) && row.profiles.length) ? row.profiles[0] : null;
    const username = profile ? profile.username : (row.user_id === currentUser.id ? currentProfile.username : "Unknown");
    const avatar = profile ? profile.avatar_url : DEFAULT_AVATAR;
    const self = currentUser && row.user_id === currentUser.id;
    insertMessageAtTop(username, avatar, row.content, self, row.created_at);
  }

  messagesLoaded += data.length;

  if (!initial) {
    messagesDiv.scrollTop = messagesDiv.scrollHeight - prevHeight;
  } else {
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  loadingMore = false;
}

messagesDiv.addEventListener('scroll', () => {
  if (messagesDiv.scrollTop === 0) {
    loadHistory(false);
  }
});

/* --------------------- send message --------------------- */
async function sendMessage(){
  const input = document.getElementById('messageInput');
  const text = input.value.trim();
  if (!text) return;
  input.value = "";

  // insert into Supabase (RLS must permit inserts by authenticated users)
  const { error } = await supabaseClient.from('messages').insert([
    { user_id: currentUser.id, content: text }
  ]);
  if (error) {
    console.error("insert error", error);
    return;
  }

  // locally append for snappy UI (we will ignore duplicate on realtime)
  appendMessage(currentProfile.username, currentProfile.avatar_url || DEFAULT_AVATAR, text, true, new Date().toISOString());

  // optional publish to Ably for non-DB real-time flows
  try { pubChannel.publish('chat-event', { type: 'sent', user_id: currentUser.id }); } catch(e){/*non-fatal*/}
}
window.sendMessage = sendMessage;

/* --------------------- realtime via Supabase (postgres_changes) --------------------- */
supabaseClient
  .channel('public:messages')
  .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, async (payload) => {
    const row = payload.new;
    // if inserted by us, ignore (we already appended)
    if (row.user_id === currentUser.id) return;

    // get profile for this user
    const { data: profile } = await supabaseClient
      .from('profiles')
      .select('username, avatar_url')
      .eq('id', row.user_id)
      .maybeSingle();

    const username = profile ? profile.username : row.user_id;
    const avatar = profile ? profile.avatar_url : DEFAULT_AVATAR;
    appendMessage(username, avatar, row.content, false, row.created_at);
  })
  .subscribe();

/* --------------------- profile editing --------------------- */
function openProfile(){
  popupBackdrop.style.display = "flex";
  usernameInput.value = currentProfile.username || "";
  avatarInput.value = currentProfile.avatar_url || "";
}
function closeProfile(){
  popupBackdrop.style.display = "none";
}
window.openProfile = openProfile;
window.closeProfile = closeProfile;

saveProfileBtn.addEventListener('click', async () => {
  const newUsername = usernameInput.value.trim() || currentProfile.username;
  const newAvatar = avatarInput.value.trim() || DEFAULT_AVATAR;

  const { error } = await supabaseClient.from('profiles').upsert([
    { id: currentUser.id, username: newUsername, avatar_url: newAvatar }
  ], { returning: 'minimal' });

  if (error) {
    console.error("profile save error", error);
    return;
  }

  currentProfile.username = newUsername;
  currentProfile.avatar_url = newAvatar;
  meName.textContent = newUsername;
  meAvatar.src = newAvatar;
  closeProfile();

  // update presence record so others see new data
  try { presenceChannel.presence.update({ avatar: newAvatar, username: newUsername }); } catch(e){/*non-fatal*/}
});

/* logout */
async function logout(){
  await supabaseClient.auth.signOut();
  window.location.href = "login.html";
}
window.logout = logout;

/* --------------------- init --------------------- */
(async function init(){
  const ok = await ensureSignedInAndProfile();
  if (!ok) return;

  // init Ably + presence
  initAblyAndPresence();

  // load initial messages (newest 30)
  await loadHistory(true);

  // wire send + enter key
  document.getElementById('sendBtn').addEventListener('click', sendMessage);
  const msgInput = document.getElementById('messageInput');
  msgInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
})();
</script>
</body>
</html>
